{% extends "base.html" %}
{% block title %}ููุญุฉ ุชุญูู ุงููุฏูุฑ{% endblock %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_custom.css') }}">
{% endblock %}
{% block content %}
<div class="dashboard-layout">
  <div class="dashboard-main">
    <div class="modern-header" style="display:flex;justify-content:flex-end;align-items:center;">
  {% from '_macros.html' import back_button %}{{ back_button(size='1.7em') }}
    </div>

    <div class="dashboard-title">ููุญุฉ ุชุญูู ุงููุฏูุฑ</div>

    <!-- quick status cards (ุฏูุฌ ุชุตููู ุงูุณูุง) -->
    <div class="stats-row" style="max-width:1100px;margin:6px auto 14px;">
      <div class="stat-card" style="background:linear-gradient(180deg,var(--purple-1),var(--purple-2));">
        <div class="card-icon">๐</div>
        <div class="stat-title">ูู ุงูุนููุฏ</div>
        <div class="stat-value">{{ metrics.total_count|default(0) }}</div>
        <div class="stat-desc">ุฌููุน ุงูุนููุฏ</div>
      </div>
      <div class="stat-card" style="background:var(--sama-accent);">
        <div class="card-icon">โณ</div>
        <div class="stat-title">ุชุญุช ุงูุฅุฌุฑุงุก</div>
        <div class="stat-value">{{ metrics.pending_count|default(0) }}</div>
        <div class="stat-desc">ุจุงูุชุธุงุฑ ุงููุนุงูุฌุฉ</div>
      </div>
      <div class="stat-card" style="background:var(--accent-red);">
        <div class="card-icon">โ</div>
        <div class="stat-title">ูุบููุฉ</div>
        <div class="stat-value">{{ metrics.closed_count|default(0) }}</div>
        <div class="stat-desc">ุงูุนููุฏ ุงูููุชููุฉ</div>
      </div>
      <div class="stat-card" style="background:var(--sama-gold);color:var(--primary-navy);">
        <div class="card-icon">๐ฅ</div>
        <div class="stat-title">ุงูููุธููู</div>
        <div class="stat-value">{{ metrics.employees_count|default(metrics.users_count|default(0)) }}</div>
        <div class="stat-desc">ุฅุฌูุงูู ุงูููุธููู</div>
      </div>
    </div>

    <!-- ููุงุตูุงุช ุงูููุฒุงุช (ูุถูููุฉ ููุนูุงูุฉ ุนุจุฑ ุงููุชุบูุฑุงุช ุงูููุฑูุฑุฉ ูู ุงูุณูุฑูุฑ) -->
    <details style="width:100%;max-width:1100px;margin:6px auto 18px;color:var(--primary-blue);">
      <summary style="cursor:pointer;font-weight:700">๐ ูุตู ููุฒุงุช ููุญุฉ ุงููุฏูุฑ (ุงููุฑ ููุนุฑุถ)</summary>
      <pre style="white-space:pre-wrap;direction:rtl;text-align:right;color:var(--primary-blue);padding:12px;background:rgba(12,37,64,0.03);border-radius:8px;margin-top:8px;">
1. ุฅุญุตุงุกุงุช ุฑุฆูุณูุฉ ููุฑูุฉ
2. ุงูุฑุณูู ุงูุจูุงููุฉ ูุงูุชุญูููุงุช
3. ุฅุฏุงุฑุฉ ุงููููุงุช ูุงูุชูููุนุงุช
4. ุงูุชูุจููุงุช ูุงูุฅุดุนุงุฑุงุช
5. ูุงุฆูุฉ ุงูููุงู (To-Do List)
6. ุขุฎุฑ ุงูุฃูุดุทุฉ
7. ุฑูุงุจุท ูุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ
8. ูุชุงุจุนุฉ ุงูููุธููู ูุงูููุฑู
9. ุงูุฃุฑุดูู ูุงูุณุฌูุงุช
10. ุฅุถุงูุงุช ุงุฎุชูุงุฑูุฉ: ุชููููุ ููุฏุฌุช ุงูุทูุณุ ููุญุฉ ุฅูุฌุงุฒุงุชุ ูุฑุงุณูุฉ ุฏุงุฎููุฉ.
      </pre>
    </details>

    <!-- ุฅุญุตุงุกุงุช ุณุฑูุนุฉ -->
    <div class="stats-row" aria-live="polite">
      <div class="stat-card" style="background:var(--secondary-cyan);color:var(--primary-navy);">
        <div class="card-icon">๐</div>
        <div class="stat-title">ูู ุงูุนููุฏ</div>
        <div class="stat-value">{{ metrics.total_count|default(0) }}</div>
        <div class="stat-desc">ุฌููุน ุงูุนููุฏ ูู ุงููุธุงู</div>
      </div>
      <div class="stat-card" style="background:var(--accent-gold);color:var(--primary-navy);">
        <div class="card-icon">โณ</div>
        <div class="stat-title">ุจุงูุชุธุงุฑ ุงูุงุนุชูุงุฏ</div>
        <div class="stat-value">{{ metrics.pending_count|default(0) }}</div>
        <div class="stat-desc">ุงูุนููุฏ ุงูุฌุฏูุฏุฉ</div>
      </div>
      <div class="stat-card" style="background:var(--accent-red);color:#fff;">
        <div class="card-icon">โ</div>
        <div class="stat-title">ุงููุบููุฉ/ุงููุฑููุถุฉ</div>
        <div class="stat-value">{{ metrics.closed_count|default(0) }}</div>
        <div class="stat-desc">ุงูุนููุฏ ุงูููุชููุฉ</div>
      </div>
      <!-- ุฅุถุงููุฉ: ููุธููู ูุฅูุฑุงุฏุงุช ุฅู ููููุฑุช -->
      <div class="stat-card" style="background:var(--sama-accent, #22B8CF);color:#fff;">
        <div class="card-icon">๐ฅ</div>
        <div class="stat-title">ุงูููุธููู</div>
        <div class="stat-value">{{ metrics.employees_count|default(metrics.users_count|default(0)) }}</div>
        <div class="stat-desc">ุฅุฌูุงูู ุงูููุธููู</div>
      </div>
    </div>

    <!-- ุงูููุญุงุช ุงููุฑูุฒูุฉ -->
  <div class="panels" style="max-width:1100px;margin:18px auto;display:grid;grid-template-columns:2fr 1fr 300px;gap:18px;">
      <!-- ุงูููุญุฉ ุงููุณุฑู: ูุฎุทุท + ููุฎุตุงุช -->
      <div style="display:flex;flex-direction:column;gap:18px;">
        <div class="auth-card" style="padding:12px;">
          <h4 style="margin:0 0 8px;text-align:right;color:var(--navy)">ูุฎุทุทุงุช ูุชุญูููุงุช</h4>
          <canvas id="chart_main" style="width:100%;height:260px" aria-label="ูุฎุทุท ุฃุฏุงุก"></canvas>
          <script id="chart-data" type="application/json">{{ chart_data|tojson|default('null') }}</script>
        </div>

        <div class="auth-card" style="padding:12px;">
          <h4 style="margin:0 0 8px;text-align:right;color:var(--navy)">ูุงุฆูุฉ ุงูููุงู</h4>
          <ul style="margin:0;padding:0;list-style:none;direction:rtl">
            {% if tasks %}
              {% for t in tasks %}
                <li style="padding:8px 6px;border-bottom:1px solid #f2f4f6;display:flex;justify-content:space-between;align-items:center">
                  <div>{{ t.title }}</div>
                  <div style="font-size:0.85rem;color:var(--muted)">โ {{ t.assigned_by or t.owner or 'ูุธุงู' }}</div>
                </li>
              {% endfor %}
            {% else %}
              <li style="padding:8px 6px;border-bottom:1px solid #f2f4f6">ูุง ุชูุฌุฏ ููุงู ุญุงููุงู</li>
            {% endif %}
          </ul>
        </div>
      </div>

      <!-- ุงูููุญุฉ ุงููููู: ูููุงุช ูููุนุงููุฉุ ุฅุดุนุงุฑุงุชุ ุฃูุดุทุฉ -->
      <div style="display:flex;flex-direction:column;gap:18px;">
        <div class="auth-card" style="padding:12px;">
          <h4 style="margin:0 0 8px;text-align:right;color:var(--navy)">ูููุงุช ูููุนุงููุฉ</h4>
          <div style="display:flex;flex-direction:column;gap:8px">
            {% set files_shown = 0 %}
            {% for act in recent_activities %}
              {% if act.type in ['file','upload'] and files_shown < 6 %}
                <div style="padding:6px;border-bottom:1px solid #f3f5f7">{{ act.title or act.name }}</div>
                {% set files_shown = files_shown + 1 %}
              {% endif %}
            {% endfor %}
            {% if files_shown == 0 %}
              <div class="muted">ูุง ุชูุฌุฏ ูููุงุช ุญุฏูุซุฉ ูููุนุงููุฉ</div>
            {% endif %}
          </div>
        </div>

        <div class="auth-card" style="padding:12px;">
          <h4 style="margin:0 0 8px;text-align:right;color:var(--navy)">ุงูุชูุจููุงุช</h4>
          <div style="font-size:0.95rem;color:var(--muted);direction:rtl">
            {% if notifications %}
        <ul style="margin:0;padding:0;list-style:none">
          {% set notifications_shown = (notifications or [])[:8] %}
          {% for n in notifications_shown %}
                  <li style="padding:8px 6px;border-bottom:1px dashed #f2f4f6;display:flex;justify-content:space-between;align-items:center">
                    <div style="max-width:75%">{{ n.message or n.title }}</div>
                    <div style="font-size:0.8rem;color:var(--primary-blue)">{{ n.human_time or n.created_at }}</div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div>ูุง ุชูุฌุฏ ุชูุจููุงุช ุฌุฏูุฏุฉ</div>
            {% endif %}
          </div>
        </div>

        <div class="auth-card" style="padding:12px;">
          <h4 style="margin:0 0 8px;text-align:right;color:var(--navy)">ุขุฎุฑ ุงูุฃูุดุทุฉ</h4>
          <div style="font-size:0.95rem;color:var(--muted);direction:rtl">
            {% if recent_activities %}
              {% set recent_activities_shown = (recent_activities or [])[:10] %}
              {% for a in recent_activities_shown %}
                <div style="padding:8px 6px;border-bottom:1px dashed #f2f4f6">
                  <div style="font-weight:700">{{ a.summary or a.title or (a.type ~ ' โ ' ~ (a.actor or 'ูุธุงู')) }}</div>
                  <div style="font-size:0.85rem;color:var(--muted)">{{ a.human_time or a.created_at }}</div>
                </div>
              {% endfor %}
            {% else %}
              <div>ูุง ุชูุฌุฏ ุฃูุดุทุฉ ุญุฏูุซุฉ</div>
            {% endif %}
          </div>
        </div>
      </div>

  {# Friends panel removed - unified layout #}
    </div>

    <!-- ุฌุฏูู ุงูุนููุฏ -->
    <h3>ูู ุงูุนููุฏ</h3>
    <div style="overflow:auto">
      <table class="contracts-table" role="table" aria-label="ูุงุฆูุฉ ุงูุนููุฏ">
        <thead>
          <tr>
            <th>ุฑูู ุงูุนูุฏ</th>
            <th>ุงูููุธู</th>
            <th>ุงูุนููู</th>
            <th>ุงูุญุงูุฉ</th>
            <th>ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
            <th>ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody>
          {% for c in all_contracts %}
          <tr>
            <td style="white-space:nowrap">{{ c.serial }}</td>
            <td>{{ c.employee_name }}</td>
            <td>{{ c.client_name }}</td>
            <td>{{ c.status_display | safe }}</td>
            <td>{{ c.created_at.strftime('%Y-%m-%d') if c.created_at else '' }}</td>
            <td style="white-space:nowrap">
              <a href="{{ url_for('contracts_detail', cid=c.id) }}" class="btn btn-outline">ุนุฑุถ</a>
              {% if c.status == 'pending' %}
                <form method="post" action="{{ url_for('manager_approve_contract', cid=c.id) }}" style="display:inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn btn-success btn-sm" type="submit">ุงุนุชูุงุฏ</button>
                </form>
                <form method="post" action="{{ url_for('manager_reject_contract', cid=c.id) }}" style="display:inline">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn btn-danger btn-sm" type="submit">ุฑูุถ</button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% if not all_contracts %}
          <tr><td colspan="6" style="text-align:center;padding:18px;color:var(--muted)">ูุง ุชูุฌุฏ ุนููุฏ ูุนุฑุถูุง</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// body class controlled centrally in base.html via auth_page

(function(){
  const dataTag = document.getElementById('chart-data');
  let data = null;
  if (dataTag) {
    try {
      data = JSON.parse(dataTag.textContent);
    } catch (e) {
      data = null;
    }
  }
  const ctx = document.getElementById('chart_main');
  if (!ctx) return;
  if (typeof Chart !== 'undefined' && data) {
    new Chart(ctx.getContext('2d'), data);
  } else {
    // ุฑุณู ุจุฏูู ุจุณูุท (ุดุฑูุท ุฑูุฒู) ูุนุฑุถ ุงูุดูู ุฏูู ููุชุจุฉ
    if (ctx.getContext) {
      const c = ctx.getContext('2d');
      c.fillStyle = '#f3f4f6';
      c.fillRect(0,0,ctx.width,ctx.height);
      c.fillStyle = '#cbd5e1';
      c.fillRect(20, ctx.height - 60, 60, 40);
      c.fillRect(100, ctx.height - 90, 60, 70);
      c.fillRect(180, ctx.height - 40, 60, 20);
      c.fillStyle = 'var(--muted)';
      c.font = '13px sans-serif';
      c.fillText('ูุฎุทุท (Chart.js ุบูุฑ ูุญููู)', 10, 20);
    }
  }
})();
</script>
{% endblock %}
